#include "script_component.hpp"

//if (!isServer) exitWith {};

systemChat "Starting Vulcano";
_this remoteExecCall ["grad_vulcano_fnc_playerInit", 0, true];

GVAR(smokeEffectTimer) = true;

[
    {
        [QGVAR(vulcanoEffect), _this] call CBA_fnc_globalEventJIP;

        [
            {
                params ["_args", "_handle"];
                _args params ["_vulcanoPos", "_radius", "_delay"];

                systemChat str GVAR(lightsFinished);

                if (!(isNil QGVAR(lightsFinished)) && {GVAR(lightsFinished)}) then {
                    GVAR(lightsFinished) = false;
                    [QGVAR(playerEffekt), [_radius]] call CBA_fnc_globalEvent;
                    [{
                        private _illuminationArea = round (1200 + random 500);
                        private _limit = round (500 + random 300);

                        [QGVAR(changeLight), [_illuminationArea, _limit]] call CBA_fnc_globalEvent;
                    }, [], random 5] call CBA_fnc_waitAndExecute;
                };

                if (GVAR(smokeEffectTimer)) then {
                    GVAR(smokeEffectTimer) = false;
                    private _type = selectRandom [1,2,3];

                    private _parameters = [];
                    private _extraTime = 0;

                    if (_type == 2) then {
                        _parameters = [(2 + random 300), (2 + random 300), (5 + random 20), (1 + random 10), (20 + random 10), (100 + random 100), (200 + random 200)];
                    };

                    if (_type == 3) then {
                        _extraTime = 25.5;
                    };

                    [QGVAR(smokeEffect), [_vulcanoPos, _type, _radius, _delay, _parameters]] call CBA_fnc_globalEvent;
                    [{GVAR(smokeEffectTimer) = true;},[], (_delay + _extraTime)] call CBA_fnc_waitAndExecute;
                };

            },
            1,
            _this
        ] call CBA_fnc_addPerFrameHandler;
    },
    _this,
    5
] call CBA_fnc_waitAndExecute
