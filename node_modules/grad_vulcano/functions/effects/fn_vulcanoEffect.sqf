#include "script_component.hpp"
if (!hasInterface) exitWith {};

systemChat "Starting Vulcano Effect";

params ["_pos", "_craterRadius"];

[{
	params ["","_handle"];

	if (isNull GVAR(vulcanoObject)) exitWith {
		[_handle] call CBA_fnc_removePerFrameHandler;
	};
	GVAR(vulcanoObject) say3d "murmur_8";
},60,GVAR(vulcanoObject)] call CBA_fnc_addPerFrameHandler;

// crater
private _crater = "#particlesource" createVehicleLocal _pos;
_crater setParticleCircle [100, [0, 0, 0]];
_crater setParticleRandom [0, [0.25, 0.25, 0], [0, 0, 0], 0, 0.5, [0, 0, 0, 0.1], 0, 0];
_crater setParticleParams [["\A3\data_f\ParticleEffects\Universal\StoneSmall.p3d", 1, 0, 1], "", "SpaceObject", 1, 14400, [0, 0, 0], [0, 0, 1], 0, 30, 7.9, 1, [15, 15, 15], [[1, 1, 1, 1], [1, 1, 1, 1], [1, 1, 1, 1]], [0.08], 1, 0, "", "", _crater,/*bounce*/0,true,0.1,[[0,0,0,0]]];
_crater setDropInterval 0.01;

[{
	params ["_pos", "_craterRadius", "_crater"];

	deleteVehicle _crater;

	private _fumObj = "Land_HelipadEmpty_F" createVehicleLocal (_pos vectorAdd [0,0,5]);
	private _fumObjPos = getPosATL _fumObj;

	//light source
	GVAR(light) = "#lightpoint" createVehicle _pos;
	GVAR(light) lightAttachObject [GVAR(vulcanoObject), [0,0,30]];
	GVAR(light) setLightAttenuation [0, 0, 0, 0, 40, 600];
	GVAR(light) setLightIntensity 1500;
	GVAR(light) setLightBrightness 30;
	GVAR(light) setLightDayLight true;
	GVAR(light) setLightUseFlare true;
	GVAR(light) setLightFlareSize 50;
	GVAR(light) setLightFlareMaxDistance 2000;
	GVAR(light) setLightAmbient[1,0.2,0.1];
	GVAR(light) setLightColor[1,0.2,0.1];

	//sparks
	private _sparks = "#particlesource" createVehicleLocal _fumObjPos;
	_sparks setParticleCircle [100, [0, 0, 10]];
	_sparks setParticleRandom [0, [0.25, 0.25, 0], [0.175, 0.175, 13], 0, 0.25, [0, 0, 0, 0.1], 0, 0];
	_sparks setParticleParams [["\A3\data_f\cl_exp", 1, 0, 1], "", "Billboard", 1, 7, [0, 0, 0], [0, 0, 17], 0.3, 71, 7.9, 1, [5, 3, 1], [[1, 1, 1, 1], [1, 1, 1, 1], [1, 1, 1, 1]], [0.08], 1, 0, "", "", _fumObj, 0,true,0.01,[[0,0,0,0]]];
	_sparks setDropInterval 0.2;

	//refract
	private _refract = "#particlesource" createVehicleLocal _fumObjPos;
	_refract setParticleCircle [100, [0, 0, 0]];
	_refract setParticleRandom [0, [0, 0, 0], [0, 0, 0], 0, 0, [1, 1, 1, 0.5], 0, 0];
	_refract setParticleParams [["\A3\data_f\ParticleEffects\Universal\Refract.p3d", 1, 0, 1], "", "Billboard", 1, 5, [0, 0, 0], [0, 0, 25], 15, 50, 7.9, 1, [25, 20, 10], [[1, 1, 1, 1], [1, 1, 1, 1], [1, 1, 1, 0.5]], [0.08], 1, 0, "", "", _fumObj];
	_refract setDropInterval 0.1;

	//damage on player
	_refract setParticleFire [0.3,300,0.5];

	//permernent smoke
	private _permernentSmoke = "#particlesource" createVehicleLocal _fumObjPos;
	_permernentSmoke setParticleCircle [100-10,[0, 0, 0]];
	_permernentSmoke setParticleParams [
		["\Ca\Data\ParticleEffects\FireAndSmokeAnim\SmokeAnim.p3d", 8, 1, 8 ],
	    "",
	    "Billboard",
	    1,
	    25,
	    [0, 0, -5],
	    [0.5, 0.5, 5],
	    1,
	    1,
	    20,
	    0.7,
	    [25, 27, 41],
	    [
	        [0.5, 0.5, 0.5, 0.3],
	        [0.25, 0.25, 0.25, 0.5],
	        [0.5, 0.5, 0.5, 0]
	    ],
	    [0.08],
	    0.1,
	    3,
	     "",
	    "",
	    _fumObj
	];
	_permernentSmoke setParticleRandom [0, [0.25, 0.25, 0], [0.2, 0.2, 0], 0, 0.25, [0, 0, 0, 0.1], 0, 0];

	_permernentSmoke setDropInterval 0.002;


}, [_pos, _craterRadius, _crater], 10] call CBA_fnc_waitAndExecute;
