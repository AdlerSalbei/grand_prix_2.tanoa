#include "script_component.hpp"
if (!hasInterface) exitWith {};

systemChat "Starting Vulcano Effect";

params ["_pos", "_craterRadius"];

[{
	params ["","_handle"];

	if (isNull GVAR(vulcanoObject)) exitWith {
		[_handle] call CBA_fnc_removePerFrameHandler;
	};
	GVAR(vulcanoObject) say3d ["murmur_8", 5000];
},60,GVAR(vulcanoObject)] call CBA_fnc_addPerFrameHandler;

[{
	params ["_pos", "_craterRadius"];


	private _effectObj = "Land_HelipadEmpty_F" createVehicleLocal (_pos vectorAdd [0,0,5]);
	private _effectObjPos = getPosATL _effectObj;

	//light source
	GVAR(light) = "#lightpoint" createVehicle _pos;
	GVAR(light) lightAttachObject [GVAR(vulcanoObject), [0,0,30]];
	GVAR(light) setLightAttenuation [0, 0, 0, 0, 40, 600];
	GVAR(light) setLightIntensity 1500;
	GVAR(light) setLightBrightness 30;
	GVAR(light) setLightDayLight true;
	GVAR(light) setLightUseFlare true;
	GVAR(light) setLightFlareSize 50;
	GVAR(light) setLightFlareMaxDistance 2000;
	GVAR(light) setLightAmbient[1,0.2,0.1];
	GVAR(light) setLightColor[1,0.2,0.1];

	//sparks
	private _sparks = "#particlesource" createVehicleLocal _effectObjPos;
	_sparks setParticleCircle [_craterRadius-20, [0, 0, 10]];
	_sparks setParticleRandom [0, [0.25, 0.25, 0], [0.175, 0.175, 13], 0, 0.25, [0, 0, 0, 0.1], 0, 0];
	_sparks setParticleParams [["\A3\data_f\cl_exp", 1, 0, 1], "", "Billboard", 1, 7, [0, 0, 0], [0, 0, 17], 0.3, 71, 7.9, 1, [5, 3, 1], [[1, 1, 1, 1], [1, 1, 1, 1], [1, 1, 1, 1]], [0.08], 1, 0, "", "", _effectObj, 0,true,0.01,[[0,0,0,0]]];
	_sparks setDropInterval 0.2;

	//Fire
	private _fire = "#particlesource" createVehicleLocal _effectObjPos;
	_fire setParticleParams [["\A3\data_f\cl_exp", 1, 0, 1], "", "Billboard", 1, 10, [0, 0, 0], [0, 0, 10], 10, 9, 7.9, 0, [150, 150, 150, 100, 100, 100, 150], [[1, 1, 1, 0.5], [1, 1, 1, 1], [1, 1, 1, 1], [1, 1, 1, 1], [1, 1, 1, 1], [1, 1, 1, 0.5], [1, 1, 1, 1]], [1], 1, 0, "", "", _effectObj];
	_fire setParticleRandom [0, [25, 25, 0], [0.175, 0.175, 0], 63, 0.1, [0,0,0,0.1], 0, 0];
	_fire setParticleCircle [30, [0, 0, 0]];
	_fire setDropInterval 0.01;

	[{
		params ["_effectObjPos"];

		//permernent smoke
		private _permernentSmoke = "#particlesource" createVehicleLocal _effectObjPos;
		_permernentSmoke setParticleParams [["\a3\Data_f\ParticleEffects\Universal\Universal", 16, 7, 48,1], "", "Billboard", 1, 10, [0, 0, 40],[0, 0, 130], 13, 1, 2, 0.01, [200,100,100,100,100],[[0, 0, 0, 0.5],[0, 0, 0, 1], [0.3, 0.3, 0.3, 1],[0, 0, 0, 0.5],[0, 0, 0, 0]],[0.25],1,0, "", "", _effectObj];
		_permernentSmoke setParticleRandom [2,[30,30,30],[0,0,0],0,0,[0,0,0,0.1],1, 0];
		_permernentSmoke setParticleCircle [80, [25, 25, 20]];
		_permernentSmoke setDropInterval 0.01;

	}, [_effectObjPos], 3] call CBA_fnc_waitAndExecute;
}, [_pos, _craterRadius], 10] call CBA_fnc_waitAndExecute;
